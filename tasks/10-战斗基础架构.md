# ä»»åŠ¡ 10ï¼šæˆ˜æ–—åŸºç¡€æ¶æ„

## ğŸ“‹ ä»»åŠ¡ç›®æ ‡
æ­å»ºæˆ˜æ–—ç³»ç»Ÿçš„åŸºç¡€æ¶æ„ï¼ŒåŒ…æ‹¬ WebSocket é€šè®¯ã€æˆ˜æ–—åŒºåŸŸã€æ•Œäººé…ç½®ã€‚

## ğŸ“ éœ€è¦åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯æ–‡ä»¶
```
backend/internal/model/
â”œâ”€â”€ battle_zone.go      # æˆ˜æ–—åŒºåŸŸæ¨¡å‹
â”œâ”€â”€ enemy.go            # æ•Œäººæ¨¡å‹
â””â”€â”€ battle.go           # æˆ˜æ–—æ¨¡å‹

backend/internal/websocket/
â”œâ”€â”€ hub.go              # WebSocket ç®¡ç†ä¸­å¿ƒ
â”œâ”€â”€ client.go           # å®¢æˆ·ç«¯è¿æ¥
â””â”€â”€ message.go          # æ¶ˆæ¯å®šä¹‰

backend/internal/data/
â”œâ”€â”€ zones_init.go       # æˆ˜æ–—åŒºåŸŸåˆå§‹åŒ–
â””â”€â”€ enemies_init.go     # æ•Œäººåˆå§‹åŒ–

backend/internal/handler/
â””â”€â”€ websocket.go        # WebSocket æ¥å£
```

### å‰ç«¯æ–‡ä»¶
```
frontend/src/
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ websocket.js    # WebSocket å®¢æˆ·ç«¯
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ battle.js       # æˆ˜æ–—çŠ¶æ€
â””â”€â”€ views/
    â””â”€â”€ Battle.vue      # æˆ˜æ–—ä¸»ç•Œé¢
```

## ğŸ“ è¯¦ç»†å®ç°è¦æ±‚

### 1. æˆ˜æ–—åŒºåŸŸæ¨¡å‹ (BattleZone)
```go
type BattleZone struct {
    ID           uint   `gorm:"primaryKey"`
    Code         string `gorm:"size:50;uniqueIndex"`
    Name         string `gorm:"size:100"`
    Description  string `gorm:"size:500"`
    MinLevel     int    `gorm:"default:1"`     // å»ºè®®æœ€ä½ç­‰çº§
    MaxLevel     int    `gorm:"default:99"`    // å»ºè®®æœ€é«˜ç­‰çº§
    EnemyCount   int    `gorm:"default:3"`     // æ¯æ³¢æ•Œäººæ•°é‡
    BossInterval int    `gorm:"default:10"`    // Bosså‡ºç°é—´éš”ï¼ˆæ³¢æ•°ï¼‰
    Icon         string `gorm:"size:200"`
    SortOrder    int    `gorm:"default:0"`
}
```

### 2. æ•Œäººæ¨¡å‹ (Enemy)
```go
type EnemyType string

const (
    EnemyTypeNormal EnemyType = "normal"  // æ™®é€šæ€ª
    EnemyTypeElite  EnemyType = "elite"   // ç²¾è‹±æ€ª
    EnemyTypeBoss   EnemyType = "boss"    // Boss
)

type Enemy struct {
    ID           uint      `gorm:"primaryKey"`
    Code         string    `gorm:"size:50;uniqueIndex"`
    Name         string    `gorm:"size:100"`
    Type         EnemyType `gorm:"size:20"`
    
    // åŸºç¡€å±æ€§
    BaseHP       int       `gorm:""`
    BaseMP       int       `gorm:""`
    BaseAttack   int       `gorm:""`
    BaseDefense  int       `gorm:""`
    BaseSpeed    int       `gorm:""`
    
    // æˆ˜åˆ©å“é…ç½®ï¼ˆJSONï¼‰
    // æ ¼å¼: [{"item_code": "bone", "quantity": 1, "chance": 0.5}]
    LootConfig   string    `gorm:"type:text"`
    
    // æŠ€èƒ½é…ç½®ï¼ˆJSONï¼‰
    SkillConfig  string    `gorm:"type:text"`
    
    Icon         string    `gorm:"size:200"`
}
```

### 3. åŒºåŸŸæ•Œäººå…³è” (ZoneEnemy)
```go
type ZoneEnemy struct {
    ID       uint `gorm:"primaryKey"`
    ZoneID   uint `gorm:"index"`
    EnemyID  uint `gorm:"index"`
    Weight   int  `gorm:"default:100"` // å‡ºç°æƒé‡
    
    Zone  BattleZone `gorm:"foreignKey:ZoneID"`
    Enemy Enemy      `gorm:"foreignKey:EnemyID"`
}
```

### 4. WebSocket æ¶ˆæ¯å®šä¹‰
```go
type WSMessageType string

const (
    // å®¢æˆ·ç«¯ -> æœåŠ¡å™¨
    MsgTypeJoinRoom    WSMessageType = "join_room"
    MsgTypeLeaveRoom   WSMessageType = "leave_room"
    MsgTypeStartBattle WSMessageType = "start_battle"
    MsgTypeAction      WSMessageType = "action"
    
    // æœåŠ¡å™¨ -> å®¢æˆ·ç«¯
    MsgTypeRoomState   WSMessageType = "room_state"
    MsgTypeBattleState WSMessageType = "battle_state"
    MsgTypeRoundStart  WSMessageType = "round_start"
    MsgTypeActionResult WSMessageType = "action_result"
    MsgTypeRoundEnd    WSMessageType = "round_end"
    MsgTypeBattleEnd   WSMessageType = "battle_end"
    MsgTypeError       WSMessageType = "error"
)

type WSMessage struct {
    Type    WSMessageType `json:"type"`
    Payload interface{}   `json:"payload"`
}
```

### 5. WebSocket Hub
```go
type Hub struct {
    clients    map[*Client]bool
    rooms      map[string]*BattleRoom
    register   chan *Client
    unregister chan *Client
    broadcast  chan *WSMessage
}

func (h *Hub) Run() {
    for {
        select {
        case client := <-h.register:
            h.clients[client] = true
        case client := <-h.unregister:
            if _, ok := h.clients[client]; ok {
                delete(h.clients, client)
                close(client.send)
            }
        case message := <-h.broadcast:
            // å¹¿æ’­æ¶ˆæ¯
        }
    }
}
```

### 6. å‰ç«¯ WebSocket å®¢æˆ·ç«¯
```javascript
// utils/websocket.js
class GameWebSocket {
  constructor() {
    this.ws = null
    this.callbacks = {}
  }
  
  connect(token) {
    const url = `ws://localhost:8080/ws?token=${token}`
    this.ws = new WebSocket(url)
    
    this.ws.onmessage = (event) => {
      const message = JSON.parse(event.data)
      if (this.callbacks[message.type]) {
        this.callbacks[message.type](message.payload)
      }
    }
  }
  
  on(type, callback) {
    this.callbacks[type] = callback
  }
  
  send(type, payload) {
    this.ws.send(JSON.stringify({ type, payload }))
  }
  
  disconnect() {
    this.ws?.close()
  }
}

export default new GameWebSocket()
```

### 7. åˆå§‹åŒºåŸŸå’Œæ•Œäººæ•°æ®
```go
var DefaultZones = []BattleZone{
    {Code: "forest", Name: "è¿·é›¾æ£®æ—", MinLevel: 1, MaxLevel: 10, EnemyCount: 3, BossInterval: 10},
    {Code: "cave", Name: "é»‘æš—æ´ç©´", MinLevel: 10, MaxLevel: 20, EnemyCount: 3, BossInterval: 10},
    {Code: "mountain", Name: "é›ªå±±", MinLevel: 20, MaxLevel: 30, EnemyCount: 4, BossInterval: 8},
}

var DefaultEnemies = []Enemy{
    {Code: "slime", Name: "å²è±å§†", Type: EnemyTypeNormal, BaseHP: 50, BaseAttack: 5, BaseDefense: 2, BaseSpeed: 3},
    {Code: "goblin", Name: "å“¥å¸ƒæ—", Type: EnemyTypeNormal, BaseHP: 80, BaseAttack: 8, BaseDefense: 3, BaseSpeed: 5},
    {Code: "wolf", Name: "é‡ç‹¼", Type: EnemyTypeNormal, BaseHP: 100, BaseAttack: 12, BaseDefense: 4, BaseSpeed: 8},
    {Code: "goblin_chief", Name: "å“¥å¸ƒæ—é¦–é¢†", Type: EnemyTypeElite, BaseHP: 200, BaseAttack: 20, BaseDefense: 8, BaseSpeed: 6},
    {Code: "forest_guardian", Name: "æ£®æ—å®ˆæŠ¤è€…", Type: EnemyTypeBoss, BaseHP: 500, BaseAttack: 35, BaseDefense: 15, BaseSpeed: 4},
}
```

### 8. API æ¥å£
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/zones | è·å–æ‰€æœ‰æˆ˜æ–—åŒºåŸŸ |
| GET | /api/zones/:code/enemies | è·å–åŒºåŸŸæ•Œäººåˆ—è¡¨ |
| WS | /ws | WebSocket è¿æ¥ |

## âœ… éªŒè¯æ£€æŸ¥ç‚¹

å®Œæˆåè¯·éªŒè¯ï¼š
1. [ ] æœåŠ¡å¯åŠ¨æ—¶åˆå§‹åŒ–æˆ˜æ–—åŒºåŸŸ
2. [ ] æœåŠ¡å¯åŠ¨æ—¶åˆå§‹åŒ–æ•Œäººæ•°æ®
3. [ ] åŒºåŸŸä¸æ•Œäººæ­£ç¡®å…³è”
4. [ ] WebSocket è¿æ¥æˆåŠŸå»ºç«‹
5. [ ] èƒ½å‘é€å’Œæ¥æ”¶ WebSocket æ¶ˆæ¯
6. [ ] æ–­çº¿é‡è¿æ­£å¸¸å·¥ä½œ
7. [ ] å‰ç«¯èƒ½è·å–åŒºåŸŸå’Œæ•Œäººä¿¡æ¯

## ğŸ”— ä¾èµ–å…³ç³»
- ä¾èµ–ï¼šä»»åŠ¡ 01ï¼ˆç”¨æˆ·è®¤è¯ï¼Œç”¨äº WebSocket é‰´æƒï¼‰
- ä¾èµ–ï¼šä»»åŠ¡ 02ï¼ˆç‰©å“ç³»ç»Ÿï¼Œç”¨äºæˆ˜åˆ©å“é…ç½®ï¼‰
