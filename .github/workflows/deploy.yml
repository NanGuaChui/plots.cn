# GitHub Actions è‡ªåŠ¨éƒ¨ç½²é…ç½®
# å½“æŽ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨æž„å»ºå¹¶éƒ¨ç½²

name: Deploy to Server

on:
  push:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  GO_VERSION: '1.22'
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ==========================================
      # 1. æ£€å‡ºä»£ç 
      # ==========================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ==========================================
      # 2. è®¾ç½® Go çŽ¯å¢ƒ
      # ==========================================
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      # ==========================================
      # 3. ç¼–è¯‘ Go åŽç«¯
      # ==========================================
      - name: Build Go backend
        run: |
          cd backend
          go mod tidy
          go mod download
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o ../plots-server ./cmd/server

      # ==========================================
      # 4. è®¾ç½® Node.js å’Œ pnpm
      # ==========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      # ==========================================
      # 5. æž„å»ºå‰ç«¯
      # ==========================================
      - name: Build frontend
        run: |
          cd frontend
          pnpm install
          pnpm run build

      # ==========================================
      # 7. å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
      # ==========================================
      - name: Prepare deployment files
        run: |
          mkdir -p deploy-package
          mv plots-server deploy-package/
          mv frontend/dist deploy-package/web
          ls -la deploy-package/

      # ==========================================
      # 8. ä¸Šä¼ åˆ°æœåŠ¡å™¨
      # ==========================================
      - name: Upload to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: 'deploy-package/*'
          target: '/tmp/plots-deploy'
          strip_components: 1

      # ==========================================
      # 9. éƒ¨ç½²å¹¶é‡å¯æœåŠ¡
      # ==========================================
      - name: Deploy and restart service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo ">>> åœæ­¢æœåŠ¡..."
            sudo systemctl stop plots || true

            echo ">>> å¤‡ä»½æ—§ç‰ˆæœ¬..."
            if [ -f /opt/plots/bin/plots-server ]; then
              sudo cp /opt/plots/bin/plots-server /opt/plots/bin/plots-server.bak
            fi

            echo ">>> éƒ¨ç½²æ–°ç‰ˆæœ¬..."
            sudo mv /tmp/plots-deploy/plots-server /opt/plots/bin/
            sudo rm -rf /opt/plots/web/*
            sudo mv /tmp/plots-deploy/web/* /opt/plots/web/

            echo ">>> è®¾ç½®æƒé™..."
            sudo chmod +x /opt/plots/bin/plots-server
            sudo chown -R www-data:www-data /opt/plots

            echo ">>> å¯åŠ¨æœåŠ¡..."
            sudo systemctl start plots

            echo ">>> æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            sudo rm -rf /tmp/plots-deploy

            echo ">>> æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            sudo systemctl status plots --no-pager || true

            echo ">>> éƒ¨ç½²å®Œæˆï¼"

      # ==========================================
      # 10. éƒ¨ç½²é€šçŸ¥ (å¯é€‰)
      # ==========================================
      - name: Deployment summary
        run: |
          echo "## ðŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
