# ä»»åŠ¡ 09ï¼šå¼ºåŒ–ç³»ç»Ÿ

## ğŸ“‹ ä»»åŠ¡ç›®æ ‡
å®ç°è£…å¤‡å¼ºåŒ–ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ¶ˆè€—ææ–™ã€å¤±è´¥ç‡ã€ä¿æŠ¤æœºåˆ¶ã€‚

## ğŸ“ éœ€è¦åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯æ–‡ä»¶
```
backend/internal/service/
â””â”€â”€ enhancement.go      # å¼ºåŒ–æœåŠ¡

backend/internal/handler/
â””â”€â”€ enhancement.go      # å¼ºåŒ–æ¥å£

backend/internal/data/
â””â”€â”€ enhance_config.go   # å¼ºåŒ–é…ç½®æ•°æ®
```

### å‰ç«¯æ–‡ä»¶
```
frontend/src/
â”œâ”€â”€ views/
â”‚   â””â”€â”€ Enhancement.vue     # å¼ºåŒ–ç•Œé¢
â””â”€â”€ components/
    â””â”€â”€ EnhanceResult.vue   # å¼ºåŒ–ç»“æœå¼¹çª—
```

## ğŸ“ è¯¦ç»†å®ç°è¦æ±‚

### 1. å¼ºåŒ–é…ç½®æ•°æ®
```go
// é€šç”¨å¼ºåŒ–å¤±è´¥ç‡ï¼ˆå¯è¢«ç‰©å“é…ç½®è¦†ç›–ï¼‰
var DefaultEnhanceFailureRates = map[int]float64{
    1:  0.00,  // 0 -> 1: 0% å¤±è´¥ç‡
    2:  0.00,  // 1 -> 2: 0% å¤±è´¥ç‡
    3:  0.05,  // 2 -> 3: 5% å¤±è´¥ç‡
    4:  0.10,  // 3 -> 4: 10% å¤±è´¥ç‡
    5:  0.15,  // 4 -> 5: 15% å¤±è´¥ç‡
    6:  0.20,  // 5 -> 6: 20% å¤±è´¥ç‡
    7:  0.30,  // 6 -> 7: 30% å¤±è´¥ç‡
    8:  0.40,  // 7 -> 8: 40% å¤±è´¥ç‡
    9:  0.50,  // 8 -> 9: 50% å¤±è´¥ç‡
    10: 0.60,  // 9 -> 10: 60% å¤±è´¥ç‡
}

// å¼ºåŒ–ææ–™æ¶ˆè€—ï¼ˆæ¯çº§ï¼‰
var DefaultEnhanceMaterialCosts = map[int]int{
    1:  1,
    2:  1,
    3:  2,
    4:  2,
    5:  3,
    6:  3,
    7:  5,
    8:  5,
    9:  8,
    10: 10,
}
```

### 2. å¼ºåŒ–ä¿æŠ¤é“å…·
```go
type EnhanceProtection struct {
    ID       uint   `gorm:"primaryKey"`
    ItemCode string `gorm:"size:50;uniqueIndex"` // ä¿æŠ¤é“å…·ä»£ç 
    Name     string `gorm:"size:100"`
    MinLevel int    `gorm:""`  // é€‚ç”¨æœ€ä½ç­‰çº§
    MaxLevel int    `gorm:""`  // é€‚ç”¨æœ€é«˜ç­‰çº§
}

// ç¤ºä¾‹ä¿æŠ¤é“å…·
var ProtectionItems = []Item{
    {Code: "protection_scroll_low", Name: "åˆçº§ä¿æŠ¤å·è½´", Description: "å¼ºåŒ–å¤±è´¥æ—¶åªé™1çº§ï¼Œé€‚ç”¨äº1-5çº§"},
    {Code: "protection_scroll_mid", Name: "ä¸­çº§ä¿æŠ¤å·è½´", Description: "å¼ºåŒ–å¤±è´¥æ—¶åªé™1çº§ï¼Œé€‚ç”¨äº6-8çº§"},
    {Code: "protection_scroll_high", Name: "é«˜çº§ä¿æŠ¤å·è½´", Description: "å¼ºåŒ–å¤±è´¥æ—¶åªé™1çº§ï¼Œé€‚ç”¨äº9-10çº§"},
}
```

### 3. å¼ºåŒ–æœåŠ¡ (EnhancementService)
```go
type EnhancementService struct {
    db *gorm.DB
}

type EnhanceRequest struct {
    InventoryItemID  uint  `json:"inventory_item_id"`
    UseProtection    bool  `json:"use_protection"`
    ProtectionItemID *uint `json:"protection_item_id,omitempty"`
}

type EnhanceResult struct {
    Success       bool   `json:"success"`
    NewLevel      int    `json:"new_level"`
    PreviousLevel int    `json:"previous_level"`
    MaterialUsed  int    `json:"material_used"`
    ProtectionUsed bool  `json:"protection_used"`
    Message       string `json:"message"`
}

// Enhance æ‰§è¡Œå¼ºåŒ–
func (s *EnhancementService) Enhance(characterID uint, req EnhanceRequest) (*EnhanceResult, error) {
    // 1. è·å–ç‰©å“ä¿¡æ¯
    // 2. æ£€æŸ¥æ˜¯å¦å¯å¼ºåŒ–ï¼ˆæ˜¯å¦è¾¾åˆ°ä¸Šé™ï¼‰
    // 3. æ£€æŸ¥å¼ºåŒ–ææ–™æ˜¯å¦å……è¶³
    // 4. å¦‚æœä½¿ç”¨ä¿æŠ¤ï¼Œæ£€æŸ¥ä¿æŠ¤é“å…·
    // 5. æ¶ˆè€—ææ–™
    // 6. è®¡ç®—æˆåŠŸ/å¤±è´¥
    // 7. æ›´æ–°ç‰©å“å¼ºåŒ–ç­‰çº§
    // 8. è¿”å›ç»“æœ
}

// GetEnhanceInfo è·å–å¼ºåŒ–ä¿¡æ¯
func (s *EnhancementService) GetEnhanceInfo(inventoryItemID uint) (*EnhanceInfo, error) {
    // è¿”å›ï¼šå½“å‰ç­‰çº§ã€ä¸‹ä¸€çº§å¤±è´¥ç‡ã€æ‰€éœ€ææ–™ã€å¼ºåŒ–ä¸Šé™
}
```

### 4. å¼ºåŒ–é€»è¾‘
```go
func (s *EnhancementService) calculateEnhanceResult(item *InventoryItem, useProtection bool) (bool, int) {
    currentLevel := item.EnhanceLevel
    targetLevel := currentLevel + 1
    
    // è·å–å¤±è´¥ç‡
    failureRate := s.getFailureRate(item.ItemID, targetLevel)
    
    // éšæœºåˆ¤å®š
    if rand.Float64() < failureRate {
        // å¼ºåŒ–å¤±è´¥
        if useProtection {
            // ä½¿ç”¨ä¿æŠ¤ï¼šåªé™1çº§
            return false, max(0, currentLevel - 1)
        } else {
            // æ— ä¿æŠ¤ï¼šé™åˆ°0çº§
            return false, 0
        }
    }
    
    // å¼ºåŒ–æˆåŠŸ
    return true, targetLevel
}
```

### 5. API æ¥å£
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/characters/:id/enhance/info/:itemId | è·å–ç‰©å“å¼ºåŒ–ä¿¡æ¯ |
| POST | /api/characters/:id/enhance | æ‰§è¡Œå¼ºåŒ– |

### 6. å‰ç«¯å¼ºåŒ–ç•Œé¢è¦ç´ 
```vue
<template>
  <div class="enhancement-view">
    <!-- ç‰©å“é€‰æ‹©åŒº -->
    <div class="item-selection">
      <h3>é€‰æ‹©è¦å¼ºåŒ–çš„è£…å¤‡</h3>
      <div class="equipment-grid">
        <!-- æ˜¾ç¤ºæ‰€æœ‰å¯å¼ºåŒ–è£…å¤‡ -->
      </div>
    </div>
    
    <!-- å¼ºåŒ–ä¿¡æ¯åŒº -->
    <div class="enhance-info" v-if="selectedItem">
      <div class="item-preview">
        <img :src="selectedItem.icon" />
        <span>{{ selectedItem.name }} +{{ selectedItem.enhanceLevel }}</span>
      </div>
      
      <div class="enhance-details">
        <p>å½“å‰ç­‰çº§: +{{ enhanceInfo.currentLevel }}</p>
        <p>ç›®æ ‡ç­‰çº§: +{{ enhanceInfo.currentLevel + 1 }}</p>
        <p>æˆåŠŸç‡: {{ (1 - enhanceInfo.failureRate) * 100 }}%</p>
        <p>æ‰€éœ€ææ–™: {{ enhanceInfo.materialName }} x {{ enhanceInfo.materialCost }}</p>
        <p>æ‹¥æœ‰æ•°é‡: {{ enhanceInfo.materialOwned }}</p>
      </div>
      
      <el-checkbox v-model="useProtection">
        ä½¿ç”¨ä¿æŠ¤å·è½´ï¼ˆå¤±è´¥åªé™1çº§ï¼‰
      </el-checkbox>
      
      <el-button 
        type="primary" 
        @click="doEnhance"
        :disabled="!canEnhance"
      >
        å¼ºåŒ–
      </el-button>
    </div>
    
    <!-- å¼ºåŒ–ç»“æœå¼¹çª— -->
    <EnhanceResultDialog 
      v-model="showResult" 
      :result="enhanceResult" 
    />
  </div>
</template>
```

### 7. å¼ºåŒ–ç»“æœåŠ¨ç”»
- æˆåŠŸï¼šç»¿è‰²å…‰æ•ˆ + æˆåŠŸéŸ³æ•ˆ
- å¤±è´¥ï¼šçº¢è‰²å…‰æ•ˆ + å¤±è´¥éŸ³æ•ˆ
- æ˜¾ç¤ºç­‰çº§å˜åŒ–

## âœ… éªŒè¯æ£€æŸ¥ç‚¹

å®Œæˆåè¯·éªŒè¯ï¼š
1. [ ] èƒ½è·å–ç‰©å“å¼ºåŒ–ä¿¡æ¯
2. [ ] ææ–™ä¸è¶³æ—¶æ— æ³•å¼ºåŒ–
3. [ ] è¾¾åˆ°å¼ºåŒ–ä¸Šé™æ—¶æ— æ³•ç»§ç»­å¼ºåŒ–
4. [ ] å¼ºåŒ–æˆåŠŸåç­‰çº§+1
5. [ ] å¼ºåŒ–å¤±è´¥ï¼ˆæ— ä¿æŠ¤ï¼‰åç­‰çº§å½’0
6. [ ] å¼ºåŒ–å¤±è´¥ï¼ˆæœ‰ä¿æŠ¤ï¼‰åç­‰çº§-1
7. [ ] ææ–™å’Œä¿æŠ¤é“å…·æ­£ç¡®æ¶ˆè€—
8. [ ] å¼ºåŒ–åè£…å¤‡å±æ€§æ­£ç¡®æ›´æ–°

## ğŸ”— ä¾èµ–å…³ç³»
- ä¾èµ–ï¼šä»»åŠ¡ 02ï¼ˆç‰©å“ç³»ç»Ÿï¼‰
- ä¾èµ–ï¼šä»»åŠ¡ 08ï¼ˆè£…å¤‡ç³»ç»Ÿï¼‰
