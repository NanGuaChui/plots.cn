# ä»»åŠ¡ 07ï¼šä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ

## ğŸ“‹ ä»»åŠ¡ç›®æ ‡
å®ç°ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿï¼Œæ”¯æŒæ‰¹é‡æ·»åŠ æŠ€èƒ½ä»»åŠ¡ï¼Œè‡ªåŠ¨é¡ºåºæ‰§è¡Œã€‚

## ğŸ“ éœ€è¦åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯æ–‡ä»¶
```
backend/internal/model/
â””â”€â”€ task_queue.go       # ä»»åŠ¡é˜Ÿåˆ—æ¨¡å‹

backend/internal/service/
â””â”€â”€ task_queue.go       # ä»»åŠ¡é˜Ÿåˆ—æœåŠ¡

backend/internal/handler/
â””â”€â”€ task_queue.go       # ä»»åŠ¡é˜Ÿåˆ—æ¥å£
```

### å‰ç«¯æ–‡ä»¶
```
frontend/src/
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ taskQueue.js    # ä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€
â”œâ”€â”€ components/
â”‚   â””â”€â”€ TaskQueuePanel.vue  # ä»»åŠ¡é˜Ÿåˆ—é¢æ¿ç»„ä»¶
â””â”€â”€ views/
    â””â”€â”€ Dashboard.vue   # ä¸»é¡µæ˜¾ç¤ºé˜Ÿåˆ—
```

## ğŸ“ è¯¦ç»†å®ç°è¦æ±‚

### 1. ä»»åŠ¡é˜Ÿåˆ—æ¨¡å‹ (TaskQueue)
```go
type TaskStatus string

const (
    TaskStatusPending   TaskStatus = "pending"    // ç­‰å¾…ä¸­
    TaskStatusExecuting TaskStatus = "executing"  // æ‰§è¡Œä¸­
    TaskStatusCompleted TaskStatus = "completed"  // å·²å®Œæˆ
    TaskStatusFailed    TaskStatus = "failed"     // å¤±è´¥
)

type TaskQueueItem struct {
    ID            uint       `gorm:"primaryKey"`
    CharacterID   uint       `gorm:"index"`
    SkillCode     string     `gorm:"size:50"`       // æŠ€èƒ½ä»£ç 
    ModuleCode    string     `gorm:"size:50"`       // å­æ¨¡å—ä»£ç 
    RepeatCount   int        `gorm:"default:1"`     // æ‰§è¡Œæ¬¡æ•°
    CompletedCount int       `gorm:"default:0"`     // å·²å®Œæˆæ¬¡æ•°
    Status        TaskStatus `gorm:"size:20"`
    SortOrder     int        `gorm:""`              // é˜Ÿåˆ—é¡ºåº
    
    StartedAt     *time.Time `gorm:""`              // å¼€å§‹æ‰§è¡Œæ—¶é—´
    CompletedAt   *time.Time `gorm:""`              // å®Œæˆæ—¶é—´
    NextExecuteAt *time.Time `gorm:""`              // ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
    
    CreatedAt     time.Time
    UpdatedAt     time.Time
}
```

### 2. ä»»åŠ¡é˜Ÿåˆ—æœåŠ¡ (TaskQueueService)
```go
type TaskQueueService struct {
    db              *gorm.DB
    gatheringService *GatheringService
    craftingService  *CraftingService
}

// AddTask æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—
func (s *TaskQueueService) AddTask(characterID uint, skillCode, moduleCode string, repeatCount int) error {
    // 1. æ£€æŸ¥é˜Ÿåˆ—é•¿åº¦ï¼ˆæœ€å¤§10ä¸ªï¼‰
    // 2. åˆ›å»ºä»»åŠ¡é¡¹
    // 3. è®¾ç½®æ’åº
}

// RemoveTask ç§»é™¤ä»»åŠ¡
func (s *TaskQueueService) RemoveTask(taskID uint) error

// ReorderTasks è°ƒæ•´ä»»åŠ¡é¡ºåº
func (s *TaskQueueService) ReorderTasks(characterID uint, taskIDs []uint) error

// GetQueue è·å–é˜Ÿåˆ—
func (s *TaskQueueService) GetQueue(characterID uint) ([]TaskQueueItem, error)

// ProcessQueue å¤„ç†é˜Ÿåˆ—ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
func (s *TaskQueueService) ProcessQueue(characterID uint) error {
    // 1. è·å–ç¬¬ä¸€ä¸ª pending æˆ– executing ä»»åŠ¡
    // 2. å¦‚æœæ˜¯ pendingï¼Œå¼€å§‹æ‰§è¡Œ
    // 3. å¦‚æœæ˜¯ executingï¼Œæ£€æŸ¥æ˜¯å¦å®Œæˆ
    // 4. å®Œæˆåå¤„ç†ä¸‹ä¸€ä¸ª
}

// StartQueueProcessor å¯åŠ¨é˜Ÿåˆ—å¤„ç†å™¨
func (s *TaskQueueService) StartQueueProcessor() {
    // å®šæ—¶æ£€æŸ¥æ‰€æœ‰è§’è‰²çš„é˜Ÿåˆ—
    // ä½¿ç”¨ goroutine å’Œ ticker
}
```

### 3. é˜Ÿåˆ—å¤„ç†é€»è¾‘
```go
func (s *TaskQueueService) executeTask(task *TaskQueueItem) error {
    // æ ¹æ®æŠ€èƒ½ç±»å‹åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡
    skill := getSkillByCode(task.SkillCode)
    
    switch skill.Category {
    case SkillCategoryGathering:
        return s.gatheringService.ExecuteModule(task.CharacterID, task.ModuleCode)
    case SkillCategoryCrafting:
        // æ£€æŸ¥ææ–™æ˜¯å¦å……è¶³
        sufficient, _, _ := s.craftingService.CheckMaterials(task.CharacterID, module.Inputs)
        if !sufficient {
            task.Status = TaskStatusFailed
            // è·³è¿‡è¿™ä¸ªä»»åŠ¡ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
            return s.ProcessQueue(task.CharacterID)
        }
        return s.craftingService.ExecuteCrafting(task.CharacterID, task.ModuleCode)
    }
}
```

### 4. API æ¥å£
| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/characters/:id/queue | è·å–ä»»åŠ¡é˜Ÿåˆ— |
| POST | /api/characters/:id/queue | æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ— |
| DELETE | /api/characters/:id/queue/:taskId | ç§»é™¤ä»»åŠ¡ |
| PUT | /api/characters/:id/queue/reorder | è°ƒæ•´ä»»åŠ¡é¡ºåº |
| POST | /api/characters/:id/queue/clear | æ¸…ç©ºé˜Ÿåˆ— |

### 5. å‰ç«¯ä»»åŠ¡é˜Ÿåˆ—é¢æ¿
```vue
<!-- TaskQueuePanel.vue æ ¸å¿ƒåŠŸèƒ½ -->
<template>
  <div class="task-queue-panel">
    <h3>ä»»åŠ¡é˜Ÿåˆ— ({{ queue.length }}/10)</h3>
    
    <draggable v-model="queue" @end="onReorder">
      <div v-for="task in queue" :key="task.id" class="task-item">
        <span class="skill-icon">{{ task.skillIcon }}</span>
        <span class="task-name">{{ task.moduleName }}</span>
        <span class="progress">{{ task.completedCount }}/{{ task.repeatCount }}</span>
        <span class="status" :class="task.status">{{ statusText(task.status) }}</span>
        <el-button size="small" @click="removeTask(task.id)">åˆ é™¤</el-button>
      </div>
    </draggable>
    
    <div v-if="currentTask" class="current-task">
      <h4>å½“å‰æ‰§è¡Œ</h4>
      <el-progress :percentage="currentProgress" />
      <p>{{ currentTask.moduleName }} - å‰©ä½™ {{ remainingTime }}s</p>
    </div>
  </div>
</template>
```

### 6. é˜Ÿåˆ—è§„åˆ™
- æœ€å¤§é˜Ÿåˆ—é•¿åº¦ï¼š10ä¸ªä»»åŠ¡
- ç”Ÿæ´»æŠ€èƒ½äº’æ–¥ï¼ˆåŒæ—¶åªæ‰§è¡Œä¸€ä¸ªï¼‰
- åˆæˆä»»åŠ¡ææ–™ä¸è¶³æ—¶è‡ªåŠ¨è·³è¿‡å¹¶æ ‡è®°å¤±è´¥
- æ”¯æŒæ‹–æ‹½æ’åº
- å®æ—¶æ˜¾ç¤ºæ‰§è¡Œè¿›åº¦

## âœ… éªŒè¯æ£€æŸ¥ç‚¹

å®Œæˆåè¯·éªŒè¯ï¼š
1. [ ] èƒ½æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—
2. [ ] é˜Ÿåˆ—é•¿åº¦é™åˆ¶ç”Ÿæ•ˆï¼ˆæœ€å¤§10ä¸ªï¼‰
3. [ ] èƒ½åˆ é™¤é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
4. [ ] æ‹–æ‹½æ’åºæ­£å¸¸å·¥ä½œ
5. [ ] ä»»åŠ¡è‡ªåŠ¨é¡ºåºæ‰§è¡Œ
6. [ ] å½“å‰æ‰§è¡Œä»»åŠ¡è¿›åº¦å®æ—¶æ›´æ–°
7. [ ] åˆæˆä»»åŠ¡ææ–™ä¸è¶³æ—¶æ­£ç¡®å¤„ç†
8. [ ] ä¸»é¡µæ­£ç¡®æ˜¾ç¤ºä»»åŠ¡é˜Ÿåˆ—

## ğŸ”— ä¾èµ–å…³ç³»
- ä¾èµ–ï¼šä»»åŠ¡ 05ï¼ˆé‡‡é›†ç±»æŠ€èƒ½ï¼‰
- ä¾èµ–ï¼šä»»åŠ¡ 06ï¼ˆåˆæˆé…æ–¹ç³»ç»Ÿï¼‰
