# ä»»åŠ¡ 12ï¼šæˆ˜æ–—æŠ€èƒ½ç³»ç»Ÿ

## ðŸ“‹ ä»»åŠ¡ç›®æ ‡
å®žçŽ°æˆ˜æ–—æŠ€èƒ½ç³»ç»Ÿï¼ŒåŒ…æ‹¬æŠ€èƒ½å­¦ä¹ ã€æŠ€èƒ½é…ç½®ã€æŠ€èƒ½é‡Šæ”¾æ¡ä»¶ã€æ•ŒäººAIã€‚

## ðŸ“ éœ€è¦åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶

### åŽç«¯æ–‡ä»¶
```
backend/internal/model/
â”œâ”€â”€ combat_skill.go         # æˆ˜æ–—æŠ€èƒ½æ¨¡åž‹
â”œâ”€â”€ skill_book.go           # æŠ€èƒ½ä¹¦æ¨¡åž‹
â””â”€â”€ character_combat_skill.go # è§’è‰²å·²å­¦æŠ€èƒ½

backend/internal/battle/
â”œâ”€â”€ skill_executor.go       # æŠ€èƒ½æ‰§è¡Œå™¨
â”œâ”€â”€ skill_condition.go      # é‡Šæ”¾æ¡ä»¶åˆ¤æ–­
â””â”€â”€ enemy_ai.go             # æ•ŒäººAI

backend/internal/data/
â”œâ”€â”€ combat_skills_init.go   # æˆ˜æ–—æŠ€èƒ½åˆå§‹åŒ–
â””â”€â”€ skill_books_init.go     # æŠ€èƒ½ä¹¦åˆå§‹åŒ–
```

### å‰ç«¯æ–‡ä»¶
```
frontend/src/
â”œâ”€â”€ views/
â”‚   â””â”€â”€ SkillConfig.vue     # æŠ€èƒ½é…ç½®ç•Œé¢
â””â”€â”€ components/
    â”œâ”€â”€ SkillCondition.vue  # é‡Šæ”¾æ¡ä»¶é…ç½®ç»„ä»¶
    â””â”€â”€ SkillList.vue       # æŠ€èƒ½åˆ—è¡¨ç»„ä»¶
```

## ðŸ“ è¯¦ç»†å®žçŽ°è¦æ±‚

### 1. æˆ˜æ–—æŠ€èƒ½æ¨¡åž‹ (CombatSkill)
```go
type SkillType string
type SkillTarget string
type DamageAttribute string

const (
    SkillTypeDamage  SkillType = "damage"   // ä¼¤å®³
    SkillTypeHeal    SkillType = "heal"     // æ²»ç–—
    SkillTypeBuff    SkillType = "buff"     // å¢žç›Š
    SkillTypeDebuff  SkillType = "debuff"   // å‡ç›Š
    SkillTypeRevive  SkillType = "revive"   // å¤æ´»
)

const (
    TargetSingleEnemy   SkillTarget = "single_enemy"   // å•ä½“æ•Œäºº
    TargetAllEnemies    SkillTarget = "all_enemies"    // å…¨ä½“æ•Œäºº
    TargetSelf          SkillTarget = "self"           // è‡ªå·±
    TargetSingleAlly    SkillTarget = "single_ally"    // å•ä½“é˜Ÿå‹
    TargetAllAllies     SkillTarget = "all_allies"     // å…¨ä½“é˜Ÿå‹
    TargetLowestHPEnemy SkillTarget = "lowest_hp_enemy" // è¡€é‡æœ€ä½Žæ•Œäºº
    TargetRandomEnemy   SkillTarget = "random_enemy"    // éšæœºæ•Œäºº
)

const (
    AttrStrength     DamageAttribute = "strength"     // åŠ›é‡
    AttrAgility      DamageAttribute = "agility"      // æ•æ·
    AttrIntelligence DamageAttribute = "intelligence" // æ™ºåŠ›
)

type CombatSkill struct {
    ID             uint            `gorm:"primaryKey"`
    Code           string          `gorm:"size:50;uniqueIndex"`
    Name           string          `gorm:"size:100"`
    Description    string          `gorm:"size:500"`
    Type           SkillType       `gorm:"size:20"`
    Target         SkillTarget     `gorm:"size:30"`
    
    // æ˜¯å¦ä¸ºè¢«åŠ¨æŠ€èƒ½
    IsPassive      bool            `gorm:"default:false"`
    
    // æ¶ˆè€—å’Œå†·å´
    MPCost         int             `gorm:"default:0"`
    Cooldown       int             `gorm:"default:0"`   // å†·å´å›žåˆæ•°
    
    // ä¼¤å®³/æ•ˆæžœè®¡ç®—
    BasePower      float64         `gorm:"default:1.0"` // åŸºç¡€ç³»æ•°
    DamageAttr     DamageAttribute `gorm:"size:20"`     // ä¼¤å®³åŸºäºŽå“ªä¸ªå±žæ€§
    
    // é™„åŠ æ•ˆæžœï¼ˆJSONï¼‰
    // æ ¼å¼: {"buff_code": "burn", "chance": 0.3, "duration": 3}
    EffectConfig   string          `gorm:"type:text"`
    
    Icon           string          `gorm:"size:200"`
    
    // æ˜¯å¦å¯æˆé•¿
    CanLevelUp     bool            `gorm:"default:true"`
}
```

### 2. è§’è‰²å·²å­¦æŠ€èƒ½ (CharacterCombatSkill)
```go
type CharacterCombatSkill struct {
    ID          uint `gorm:"primaryKey"`
    CharacterID uint `gorm:"index"`
    SkillID     uint `gorm:"index"`
    Level       int  `gorm:"default:1"`     // æŠ€èƒ½ç­‰çº§
    Experience  int  `gorm:"default:0"`     // æŠ€èƒ½ç»éªŒ
    
    CombatSkill CombatSkill `gorm:"foreignKey:SkillID"`
}

// æ¯ä½¿ç”¨ä¸€æ¬¡æŠ€èƒ½èŽ·å¾—1ç‚¹ç»éªŒ
// ç»éªŒè¾¾åˆ° level * 50 æ—¶å‡çº§
```

### 3. æŠ€èƒ½é…ç½® (SkillConfig)
```go
type SkillConfig struct {
    SkillID      uint             `json:"skill_id"`
    Enabled      bool             `json:"enabled"`      // æ˜¯å¦å¯ç”¨
    Priority     int              `json:"priority"`     // ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°è¶Šä¼˜å…ˆï¼‰
    Conditions   []SkillCondition `json:"conditions"`   // é‡Šæ”¾æ¡ä»¶
}

type ConditionType string

const (
    ConditionStatus   ConditionType = "status"    // çŠ¶æ€åˆ¤æ–­
    ConditionCount    ConditionType = "count"     // æ•°é‡åˆ¤æ–­
    ConditionExist    ConditionType = "exist"     // å­˜åœ¨åˆ¤æ–­
)

type ConditionTarget string

const (
    CondTargetSelf    ConditionTarget = "self"    // è‡ªå·±
    CondTargetEnemy   ConditionTarget = "enemy"   // æ•Œæ–¹
    CondTargetAlly    ConditionTarget = "ally"    // å‹æ–¹
)

type StatusCheckMode string

const (
    StatusAllContain     StatusCheckMode = "all_contain"     // å…¨éƒ¨åŒ…å«
    StatusAnyContain     StatusCheckMode = "any_contain"     // å­˜åœ¨åŒ…å«
    StatusAllNotContain  StatusCheckMode = "all_not_contain" // å…¨éƒ¨ä¸åŒ…å«
    StatusAnyNotContain  StatusCheckMode = "any_not_contain" // å­˜åœ¨ä¸åŒ…å«
)

type SkillCondition struct {
    Type          ConditionType   `json:"type"`
    Target        ConditionTarget `json:"target"`
    
    // çŠ¶æ€åˆ¤æ–­ä¸“ç”¨
    StatusMode    StatusCheckMode `json:"status_mode,omitempty"`
    StatusCodes   []string        `json:"status_codes,omitempty"` // burn, freeze, stun, dead, alive
    
    // æ•°é‡åˆ¤æ–­ä¸“ç”¨
    CountOperator string          `json:"count_operator,omitempty"` // >, <, =, >=, <=
    CountValue    int             `json:"count_value,omitempty"`
    
    // å­˜åœ¨åˆ¤æ–­ä¸“ç”¨
    ExistType     string          `json:"exist_type,omitempty"` // boss, elite
}
```

### 4. æŠ€èƒ½æ¡ä»¶åˆ¤æ–­
```go
type ConditionChecker struct {
    state *BattleState
}

// CheckConditions æ£€æŸ¥æ‰€æœ‰æ¡ä»¶æ˜¯å¦æ»¡è¶³
func (c *ConditionChecker) CheckConditions(unit *BattleUnit, conditions []SkillCondition) bool {
    for _, cond := range conditions {
        if !c.checkSingleCondition(unit, cond) {
            return false
        }
    }
    return true
}

func (c *ConditionChecker) checkSingleCondition(unit *BattleUnit, cond SkillCondition) bool {
    switch cond.Type {
    case ConditionStatus:
        return c.checkStatusCondition(unit, cond)
    case ConditionCount:
        return c.checkCountCondition(cond)
    case ConditionExist:
        return c.checkExistCondition(cond)
    }
    return false
}

// checkStatusCondition æ£€æŸ¥çŠ¶æ€æ¡ä»¶
func (c *ConditionChecker) checkStatusCondition(unit *BattleUnit, cond SkillCondition) bool {
    targets := c.getTargets(unit, cond.Target)
    
    switch cond.StatusMode {
    case StatusAllContain:
        // æ‰€æœ‰ç›®æ ‡éƒ½åŒ…å«æŒ‡å®šçŠ¶æ€
        for _, t := range targets {
            for _, code := range cond.StatusCodes {
                if !t.HasStatus(code) {
                    return false
                }
            }
        }
        return true
    case StatusAnyContain:
        // ä»»ä¸€ç›®æ ‡åŒ…å«ä»»ä¸€æŒ‡å®šçŠ¶æ€
        for _, t := range targets {
            for _, code := range cond.StatusCodes {
                if t.HasStatus(code) {
                    return true
                }
            }
        }
        return false
    // ... å…¶ä»–æ¨¡å¼
    }
    return false
}
```

### 5. æ•Œäºº AI
```go
type EnemyAI struct {
    enemy       *BattleUnit
    skillConfig []SkillConfig // æ•Œäººä¹Ÿæœ‰æŠ€èƒ½é…ç½®
}

// DecideAction å†³å®šæ•Œäººè¡ŒåŠ¨
func (ai *EnemyAI) DecideAction(state *BattleState) *Action {
    checker := &ConditionChecker{state: state}
    
    // æŒ‰ä¼˜å…ˆçº§éåŽ†æŠ€èƒ½
    sort.Slice(ai.skillConfig, func(i, j int) bool {
        return ai.skillConfig[i].Priority < ai.skillConfig[j].Priority
    })
    
    for _, config := range ai.skillConfig {
        if !config.Enabled {
            continue
        }
        
        skill := getSkillByID(config.SkillID)
        
        // æ£€æŸ¥è“é‡
        if ai.enemy.CurrentMP < skill.MPCost {
            continue
        }
        
        // æ£€æŸ¥å†·å´
        if ai.isOnCooldown(config.SkillID) {
            continue
        }
        
        // æ£€æŸ¥æ¡ä»¶
        if checker.CheckConditions(ai.enemy, config.Conditions) {
            return &Action{
                SkillID: config.SkillID,
                Target:  ai.selectTarget(skill),
            }
        }
    }
    
    // é»˜è®¤æ™®é€šæ”»å‡»
    return &Action{SkillID: BASIC_ATTACK_ID}
}
```

### 6. æŠ€èƒ½ä¹¦å­¦ä¹ 
```go
type SkillBook struct {
    ID      uint   `gorm:"primaryKey"`
    ItemID  uint   `gorm:"uniqueIndex"` // å…³è”ç‰©å“
    SkillID uint   `gorm:"index"`       // å­¦ä¹ çš„æŠ€èƒ½
    
    Item  Item        `gorm:"foreignKey:ItemID"`
    Skill CombatSkill `gorm:"foreignKey:SkillID"`
}

// LearnSkill ä½¿ç”¨æŠ€èƒ½ä¹¦å­¦ä¹ æŠ€èƒ½
func LearnSkill(characterID uint, itemID uint) error {
    // 1. æ£€æŸ¥ç‰©å“æ˜¯å¦æ˜¯æŠ€èƒ½ä¹¦
    // 2. æ£€æŸ¥æ˜¯å¦å·²å­¦ä¹ 
    // 3. æ¶ˆè€—æŠ€èƒ½ä¹¦
    // 4. æ·»åŠ æŠ€èƒ½åˆ°è§’è‰²
}
```

### 7. åˆå§‹æŠ€èƒ½æ•°æ®
```go
var DefaultCombatSkills = []CombatSkill{
    // åŸºç¡€æŠ€èƒ½
    {Code: "basic_attack", Name: "æ™®é€šæ”»å‡»", Type: SkillTypeDamage, Target: TargetSingleEnemy,
     IsPassive: false, MPCost: 0, Cooldown: 0, BasePower: 1.0, DamageAttr: AttrStrength, CanLevelUp: false},
    
    // ä¼¤å®³æŠ€èƒ½
    {Code: "power_strike", Name: "å¼ºåŠ›ä¸€å‡»", Type: SkillTypeDamage, Target: TargetSingleEnemy,
     MPCost: 10, Cooldown: 2, BasePower: 1.8, DamageAttr: AttrStrength},
    {Code: "fireball", Name: "ç«çƒæœ¯", Type: SkillTypeDamage, Target: TargetSingleEnemy,
     MPCost: 15, Cooldown: 3, BasePower: 2.0, DamageAttr: AttrIntelligence,
     EffectConfig: `{"buff_code": "burn", "chance": 0.3, "duration": 3}`},
    
    // ç¾¤ä½“æŠ€èƒ½
    {Code: "whirlwind", Name: "æ—‹é£Žæ–©", Type: SkillTypeDamage, Target: TargetAllEnemies,
     MPCost: 25, Cooldown: 4, BasePower: 1.2, DamageAttr: AttrStrength},
    
    // æ²»ç–—æŠ€èƒ½
    {Code: "heal", Name: "æ²»ç–—æœ¯", Type: SkillTypeHeal, Target: TargetSingleAlly,
     MPCost: 20, Cooldown: 2, BasePower: 1.5, DamageAttr: AttrIntelligence},
    
    // å¤æ´»æŠ€èƒ½
    {Code: "revive", Name: "å¤æ´»æœ¯", Type: SkillTypeRevive, Target: TargetSingleAlly,
     MPCost: 50, Cooldown: 10, BasePower: 0.5}, // å¤æ´»åŽ50%è¡€é‡
}
```

## âœ… éªŒè¯æ£€æŸ¥ç‚¹

å®ŒæˆåŽè¯·éªŒè¯ï¼š
1. [ ] åˆå§‹åªæœ‰æ™®é€šæ”»å‡»æŠ€èƒ½
2. [ ] èƒ½ä½¿ç”¨æŠ€èƒ½ä¹¦å­¦ä¹ æ–°æŠ€èƒ½
3. [ ] æŠ€èƒ½é…ç½®ï¼ˆå¯ç”¨/ä¼˜å…ˆçº§ï¼‰æ­£å¸¸ä¿å­˜
4. [ ] æŠ€èƒ½æ¡ä»¶åˆ¤æ–­æ­£ç¡®
5. [ ] æ•ŒäººAIæ ¹æ®é…ç½®é‡Šæ”¾æŠ€èƒ½
6. [ ] æŠ€èƒ½ç»éªŒæ­£ç¡®ç´¯ç§¯
7. [ ] æŠ€èƒ½ç­‰çº§æå‡åŽæ•ˆæžœå¢žå¼º
8. [ ] è“é‡å’Œå†·å´æ­£ç¡®é™åˆ¶æŠ€èƒ½ä½¿ç”¨

## ðŸ”— ä¾èµ–å…³ç³»
- ä¾èµ–ï¼šä»»åŠ¡ 02ï¼ˆç‰©å“ç³»ç»Ÿï¼ŒæŠ€èƒ½ä¹¦ä¸ºç‰©å“ï¼‰
- ä¾èµ–ï¼šä»»åŠ¡ 11ï¼ˆæˆ˜æ–—å›žåˆæœºåˆ¶ï¼‰
